cmake_minimum_required (VERSION 3.0)
project (picam)

#
# Find packages
#

# Package Config
find_package(PkgConfig REQUIRED)

# Pthreads
find_package (Threads REQUIRED)

# Also
find_package(ALSA REQUIRED) 

# OpenSSL Crypto Library
find_package(OpenSSL REQUIRED) 

#
#	Find libraries using Package config
#

# Harfbuzz
pkg_check_modules(HARFBUZZ REQUIRED harfbuzz)
include_directories(SYSTEM PUBLIC ${HARFBUZZ_INCLUDE_DIRS})

# LibFreetype2
pkg_check_modules(FREETYPE2 REQUIRED freetype2)
include_directories(SYSTEM PUBLIC ${FREETYPE2_INCLUDE_DIRS})

# LibFontconfig
pkg_check_modules(FONTCONFIG REQUIRED fontconfig)
include_directories(SYSTEM PUBLIC ${FONTCONFIG_INCLUDE_DIRS})

# LibAVFormat
pkg_check_modules(LIBAVFORMAT REQUIRED libavformat)
include_directories(SYSTEM PUBLIC ${LIBAVFORMAT_INCLUDE_DIRS})

# LibAVCodec
pkg_check_modules(LIBAVCODEC REQUIRED libavcodec)
include_directories(SYSTEM PUBLIC ${LIBAVCODEC_INCLUDE_DIRS})

#
# Find packages using package config from /opt/vc
#
set(ENV{PKG_CONFIG_PATH}  "/opt/vc/lib/pkgconfig")
pkg_check_modules(RPI_GPU REQUIRED bcm_host brcmegl brcmglesv2)
include_directories(SYSTEM PUBLIC ${RPI_GPU_INCLUDE_DIRS})
link_directories(${RPI_GPU_LIBRARY_DIRS})

#
# LibILClient
#

find_path(LIBILCLIENT_INCLUDE_DIR ilclient.h
	HINTS /opt/vc/src/hello_pi/libs/ilclient
)

find_library(LIBILCLIENT_LIBRARY NAMES ilclient libilclient
	HINTS	/opt/vc/src/hello_pi/libs/ilclient
)

include_directories(${LIBILCLIENT_INCLUDE_DIR})

#
# Load the other files from picam
#
ADD_LIBRARY(HelperFunctions 
    hooks.c
    mpegts.c
    httplivestreaming.c
    state.c
    log.c
    text.c
    timestamp.c
    subtitle.c
    dispmanx.c
)

#
#	Create Executable
#

add_executable(picam stream.c)
target_link_libraries(picam HelperFunctions)

#
# Link libraries found by find_package
#

# Pthreads
target_link_libraries (picam ${CMAKE_THREAD_LIBS_INIT})

# Alsa
target_link_libraries(picam ${ALSA_LIBRARIES})   

# OpenSSL Crypto
target_link_libraries(picam ${OPENSSL_CRYPTO_LIBRARY})   

#
# Link libraries found by PackageConfig
#

# Harfbuzz
target_link_libraries(picam ${HARFBUZZ_LIBRARIES})

# Freetype2
target_link_libraries(picam ${FREETYPE2_LIBRARIES})

# Fontconfig
target_link_libraries(picam ${FONTCONFIG_LIBRARIES})

# Libavformat
target_link_libraries(picam ${LIBAVFORMAT_LIBRARIES})

# Libavcodev
target_link_libraries(picam ${LIBAVCODEC_LIBRARIES})

#
# Link Raspberry Pi libraries
#

# libilclient
target_link_libraries(picam ${LIBILCLIENT_LIBRARY})

# Libraries in /opt/vc
target_link_libraries (picam ${RPI_GPU_LIBRARIES} )

